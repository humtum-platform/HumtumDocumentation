<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
</head>
<body>
<h1 id="use-the-humtum-platform-to-build-sentinel">Use the Humtum Platform to build Sentinel</h1>
<h2 id="start-humtum-platform-locally">Start humtum-platform locally</h2>
<p>To start:</p>
<ul>
<li>Clone the humtum source code</li>
<li>Make sure you have rvm and yarn (Node.js) installed.</li>
<li><p>Run rvm to install the ruby environment</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">rvm</span> install 2.4.2</code></pre></div></li>
<li><p>After the rvm is installed, reenter the root project directory and run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">bundle</span> install</code></pre></div></li>
<li><p>Then goto the <code>./client</code> folder, then run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">yarn</span> install</code></pre></div></li>
<li><p>Go back to the root project directory, create <code>.env</code> file with the following content ```bash</p></li>
</ul>
<p>export AUTH0_RUBY_CLIENT_ID=<Management API client ID> export AUTH0_RUBY_CLIENT_SECRET=<Management API client Secret>&gt; ```</p>
<ul>
<li><p>Run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">source</span> .env</code></pre></div></li>
<li><p>Run this to start the server ```bash</p></li>
</ul>
<p>Rake db:migrate Rake start</p>
<pre><code>Now your humtum server should be running on localhost:3000

## Use humtum to create Sentinel backend

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/fgprqPhzPEE&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&quot; allowfullscreen&gt;&lt;/iframe&gt;


After creating the app, remember your app name and app id.

&lt;img width=&quot;560&quot; src=&quot;./appid.png&quot;/&gt;

## Create the Sentinel Chrome extension

Step 1. Clone [Humtum Chrome Extension Example](https://github.com/humtum-platform/HumtumChromeExtensionExample). The Sentinel Chrome Extension is in the `sentinel` folder. Make sure that the Extension ID stay constant using the following steps:

* In the `chrome://extensions/` page, pack the extension using `Pack extension` features by specifying the root location of the Chrome extension (`&lt;YOUR-PATH&gt;/HumtumChromeExtensionExample/sentinel`)
* Use [this webapp](https://robwu.nl/crxviewer/) to view the crx file
* Open the browser console to get following line
</code></pre>
<p>&quot;key&quot;: &quot;<your-chrome-extension-key>&quot;, ``<code>* copy this</code>&quot;key&quot;: ...<code>into your</code>manifest.json` * Load the unpacked extension and get your extension ID. This is the constant extension id</p>
<p>Step 2. Remember your extension ID for OIDC client registration later</p>
<p>Step 3. Create env.js file like <a href="https://github.com/humtum-platform/HumtumChromeExtensionExample/blob/master/sentinel/src/background/env.js">this</a> with your Auth0 Credential.</p>
<p>Step 4. Load the unpacked extension into Chrome.</p>
<h2 id="create-the-sentinel-electron-app">Create the Sentinel electron app</h2>
<ul>
<li>Read the <a href="https://auth0.com/blog/securing-electron-applications-with-openid-connect-and-oauth-2/#Electron-Overview">overview</a> about Electron.</li>
<li>The source code for this example is <a href="https://github.com/humtum-platform/HumtumNodeExample/tree/master/sentinel">here</a></li>
</ul>
<h3 id="register-sentinel-client-application">Register Sentinel client application</h3>
<ul>
<li><p>First, you need to register a client ID using humtum-platform OIDC dynamic client registration endpoint, for example</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> --location --request POST <span class="st">&#39;localhost:3000/clients&#39;</span> \
--header <span class="st">&#39;Content-Type: application/json&#39;</span> \
--data-raw <span class="st">&#39;{</span>
<span class="st">&quot;client_name&quot;: &quot;Sentinel&quot;,</span>
<span class="st">&quot;redirect_uris&quot;: [&quot;https://com.example.sendtinel&quot;, &quot;chrome-extension://&lt;your-extension-id&gt;&quot;, &quot;https://&lt;extension-id&gt;.chromiumapp.org/auth0&quot;]</span>
<span class="st">}&#39;</span></code></pre></div></li>
<li><p>The result will be like. Save your credential in a safe place.</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
<span class="dt">&quot;tenant&quot;</span><span class="fu">:</span> <span class="st">&quot;humtum&quot;</span><span class="fu">,</span>
<span class="dt">&quot;global&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span>
<span class="dt">&quot;is_token_endpoint_ip_header_trusted&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span>
<span class="dt">&quot;is_first_party&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span>
<span class="dt">&quot;oidc_conformant&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
<span class="dt">&quot;callbacks&quot;</span><span class="fu">:</span>  <span class="ot">[</span><span class="st">&quot;https://com.example.sendtinel&quot;</span><span class="ot">,</span> <span class="st">&quot;chrome-extension://&lt;your-extension-id&gt;&quot;</span><span class="ot">,</span> <span class="st">&quot;https://&lt;extension-id&gt;.chromiumapp.org/auth0&quot;</span><span class="ot">]</span><span class="fu">,</span>
<span class="dt">&quot;refresh_token&quot;</span><span class="fu">:</span> <span class="fu">{</span>
    <span class="dt">&quot;token_lifetime&quot;</span><span class="fu">:</span> <span class="dv">2592000</span><span class="fu">,</span>
    <span class="dt">&quot;leeway&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span>
    <span class="dt">&quot;rotation_type&quot;</span><span class="fu">:</span> <span class="st">&quot;rotating&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;expiration_type&quot;</span><span class="fu">:</span> <span class="st">&quot;expiring&quot;</span>
<span class="fu">},</span>
<span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sentinel&quot;</span><span class="fu">,</span>
<span class="dt">&quot;sso_disabled&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span>
<span class="dt">&quot;cross_origin_auth&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span>
<span class="dt">&quot;encrypted&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
<span class="dt">&quot;signing_keys&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;keys&gt;&quot;</span><span class="fu">,</span>
<span class="dt">&quot;client_id&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;Client ID&gt;&quot;</span><span class="fu">,</span>
<span class="dt">&quot;callback_url_template&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span>
<span class="dt">&quot;client_secret&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;Client Secret&gt;&quot;</span><span class="fu">,</span>
<span class="dt">&quot;jwt_configuration&quot;</span><span class="fu">:</span> <span class="fu">{</span>
    <span class="dt">&quot;lifetime_in_seconds&quot;</span><span class="fu">:</span> <span class="dv">36000</span><span class="fu">,</span>
    <span class="dt">&quot;secret_encoded&quot;</span><span class="fu">:</span> <span class="kw">false</span>
<span class="fu">},</span>
<span class="dt">&quot;grant_types&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;authorization_code&quot;</span><span class="ot">,</span> <span class="st">&quot;implicit&quot;</span><span class="ot">,</span> <span class="st">&quot;refresh_token&quot;</span><span class="ot">,</span> <span class="st">&quot;client_credentials&quot;</span><span class="ot">]</span><span class="fu">,</span>
<span class="dt">&quot;custom_login_page_on&quot;</span><span class="fu">:</span> <span class="kw">true</span>
<span class="fu">}</span></code></pre></div>
<h3 id="implementing-the-electron-client">Implementing the Electron Client</h3></li>
</ul>
<p>Note: Our Sentinel example is a modification of <a href="https://auth0.com/blog/securing-electron-applications-with-openid-connect-and-oauth-2/#Creating-the-Electron-Application">this blog</a>. Read the blog before continue with this tutorial.</p>
<ul>
<li>Clone <a href="https://github.com/humtum-platform/HumtumNodeExample">this repo</a></li>
<li>Go to <code>sentinel</code> folder. Run <code>npm i</code> to install all the dependencies.</li>
<li><p>Create <code>env-variables.json</code> file for your application with the following</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
  <span class="dt">&quot;apiIdentifier&quot;</span><span class="fu">:</span> <span class="st">&quot;com.humtum.api.&lt;YOUR-APP-NAME&gt;&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;auth0Domain&quot;</span><span class="fu">:</span> <span class="st">&quot;humtum.auth0.com&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;clientId&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;YOUR-CLIENT-ID&gt;&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;appId&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;YOUR-APP-ID&gt;&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;redirectUri&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;one-of-YOUR-redirect-uris&gt;&quot;</span>
<span class="fu">}</span></code></pre></div>
<p>Note: Our app uses <code>keytar</code> to remember sensitive informations like the <em>refresh token</em> similar to the blog examples.</p></li>
</ul>
<h4 id="authenticating-users-in-electron-applications">Authenticating Users in Electron Applications</h4>
<p>Our example uses the <a href="https://auth0.com/docs/api-auth/tutorials/authorization-code-grant-pkce">authorization code flow with pkce</a> and refresh token rotation enabled. In fact, all the clients that register through Humtum Platform has Refresh Token rotation enabled.</p>
<p>For this authorization flow, we need to implement in <code>./services/auth-service.js</code> the following functions:</p>
<ul>
<li><code>getPKCEURLandSecret</code> : returns the complete URL of the Authorization Server that users have to visit to authenticate and the PKCE secret for the PKCE flow.</li>
<li><code>extractCode</code>: extract the code and the secret from callback URL returned by the Authorization Server</li>
<li><code>exchangeCodeForToken</code>: exchange the code from the Authorization Server for the access token and the refresh token. The refresh token needs to be stored securely on the device using keytar</li>
<li><code>refreshTokens</code>: use the refresh tokens to get the new access token</li>
</ul>
<p>Code in <code>./main/auth-process.js</code> show how to authenticate using these functions</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// ./main/auth-process.js </span>
<span class="kw">const</span> <span class="op">{</span>BrowserWindow<span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;electron&#39;</span>)<span class="op">;</span>
<span class="kw">const</span> authService <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../services/auth-service&#39;</span>)<span class="op">;</span>
<span class="kw">const</span> <span class="op">{</span>createAppWindow<span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../main/app-process&#39;</span>)<span class="op">;</span>
<span class="kw">const</span> humtum <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../services/humtum&#39;</span>)
<span class="kw">const</span> envVariables <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../env-variables&#39;</span>)<span class="op">;</span>


<span class="kw">let</span> win <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

<span class="kw">function</span> <span class="at">createAuthWindow</span>() <span class="op">{</span>
  <span class="at">destroyAuthWin</span>()<span class="op">;</span>

  <span class="co">// Create the browser window.</span>
  win <span class="op">=</span> <span class="kw">new</span> <span class="at">BrowserWindow</span>(<span class="op">{</span>
    <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span>
    <span class="dt">height</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>

<span class="kw">function</span> <span class="at">authenticateUsingAuthWindow</span>() <span class="op">{</span>
  <span class="kw">const</span> <span class="op">{</span> apiIdentifier<span class="op">,</span> redirectUri <span class="op">}</span> <span class="op">=</span> envVariables
  <span class="kw">const</span> <span class="op">{</span>
    url<span class="op">,</span>
    secret
  <span class="op">}</span> <span class="op">=</span> <span class="va">authService</span>.<span class="at">getPKCEURLandSecret</span>(<span class="op">{</span>
    <span class="dt">audience</span><span class="op">:</span> apiIdentifier<span class="op">,</span>
    <span class="dt">scope</span><span class="op">:</span> <span class="st">&quot;openid email profile offline_access read:appdata write:appdata&quot;</span><span class="op">,</span>
    <span class="dt">redirect_uri</span><span class="op">:</span> redirectUri
  <span class="op">}</span>)

  <span class="va">win</span>.<span class="at">loadURL</span>(url)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span><span class="dt">session</span><span class="op">:</span> <span class="op">{</span>webRequest<span class="op">}}</span> <span class="op">=</span> <span class="va">win</span>.<span class="at">webContents</span><span class="op">;</span>

  <span class="kw">const</span> filter <span class="op">=</span> <span class="op">{</span>
    <span class="dt">urls</span><span class="op">:</span> [
      <span class="vs">`</span><span class="sc">${</span>redirectUri<span class="sc">}</span><span class="vs">/*`</span>
    ]
  <span class="op">};</span>

  <span class="va">webRequest</span>.<span class="at">onBeforeRequest</span>(filter<span class="op">,</span> <span class="at">async</span> (<span class="op">{</span>url<span class="op">}</span>) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">try</span> <span class="op">{</span>
      <span class="kw">const</span> <span class="op">{</span>code <span class="op">,</span> state<span class="op">}</span> <span class="op">=</span> <span class="va">authService</span>.<span class="at">extractCode</span>(url)
      await <span class="va">authService</span>.<span class="at">exchangeCodeForToken</span>(code<span class="op">,</span> secret<span class="op">,</span> state)
      <span class="co">// await authService.loadTokens(url);</span>

      await <span class="va">humtum</span>.<span class="at">enrollInApp</span>(<span class="va">envVariables</span>.<span class="at">appId</span><span class="op">,</span> (e) <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="at">createAppWindow</span>()<span class="op">;</span>
        <span class="at">destroyAuthWin</span>()<span class="op">;</span>
      <span class="op">}</span>).<span class="at">then</span>(data <span class="op">=&gt;</span> <span class="op">{</span>

        <span class="cf">if</span> (data <span class="op">==</span> <span class="kw">null</span>) <span class="cf">return</span>
        <span class="at">authenticateUsingAuthWindow</span>()<span class="op">;</span>

      <span class="op">}</span>)
    <span class="op">}</span> <span class="cf">catch</span>(error)<span class="op">{</span>
      <span class="va">console</span>.<span class="at">error</span>(error)<span class="op">;</span>

    <span class="op">};</span>

  <span class="op">}</span>)<span class="op">;</span>

  <span class="va">win</span>.<span class="at">on</span>(<span class="st">&#39;authenticated&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>

    <span class="at">destroyAuthWin</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="va">win</span>.<span class="at">on</span>(<span class="st">&#39;closed&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    win <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>

<span class="kw">function</span> <span class="at">destroyAuthWin</span>() <span class="op">{</span>
  <span class="cf">if</span> (<span class="op">!</span>win) <span class="cf">return</span><span class="op">;</span>
  <span class="va">win</span>.<span class="at">close</span>()<span class="op">;</span>
  win <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
<span class="op">}</span>

<span class="kw">function</span> <span class="at">createLogoutWindow</span>() <span class="op">{</span>
  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>(resolve <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> logoutWindow <span class="op">=</span> <span class="kw">new</span> <span class="at">BrowserWindow</span>(<span class="op">{</span>
      <span class="dt">show</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>

    <span class="va">logoutWindow</span>.<span class="at">loadURL</span>(<span class="va">authService</span>.<span class="at">getLogOutUrl</span>())<span class="op">;</span>

    <span class="va">logoutWindow</span>.<span class="at">on</span>(<span class="st">&#39;ready-to-show&#39;</span><span class="op">,</span> <span class="at">async</span> () <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="va">logoutWindow</span>.<span class="at">close</span>()<span class="op">;</span>
      await <span class="va">authService</span>.<span class="at">logout</span>()<span class="op">;</span>
      <span class="at">resolve</span>()<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>

<span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span>
  createAuthWindow<span class="op">,</span>
  createLogoutWindow<span class="op">,</span>
  authenticateUsingAuthWindow
<span class="op">};</span></code></pre></div>
<p>First, use function <code>getPKCEURLandSecret</code> to get the authentication url and secret. The options passed to the function needs to contain the following fields.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="op">{</span>
    <span class="dt">audience</span><span class="op">:</span> apiIdentifier<span class="op">,</span>
    <span class="dt">scope</span><span class="op">:</span> <span class="st">&quot;openid email profile offline_access read:appdata write:appdata&quot;</span><span class="op">,</span>
    <span class="dt">redirect_uri</span><span class="op">:</span> redirectUri
<span class="op">}</span></code></pre></div>
<p>Then, load the URL using the Electron window. We need to set up a filter so that the browser window can call a callback function when the Authorization Server call the callback url with the code and secret when the user authenticates successfully. This callback function should <code>extractCode</code> from the callback url and the <code>exchangeCodeForToken</code> so that our authentication service can get the access token. Once this is successful, you can use the humtum.js function to call the Humtum-platform API. In this example, we check whether the user has enrolled into our app. If she has, the app window can be launch. Otherwise, enroll the user and then reauthenticate to get the user's permission to access her app's data.</p>
<p>Once the user is authenticated and enrolled, we can start building Sentinel Electron Client!</p>
<h3 id="implementing-sentinel-electron-application.">Implementing Sentinel Electron application.</h3>
<p>Sentinel is an application that allows an expert to send a message about security issues for his / her followers. Therefore, the MVP for our app would have the following functions:</p>
<ul>
<li>Followers and Followig list</li>
<li>Search people and Follow people</li>
<li>Notifications for followers' request</li>
<li>Approve and reject follow's request</li>
<li>Broadcast a message</li>
<li>Show user's profile</li>
</ul>
<p>All these functions are implemented in the <code>./renderers</code> folder. To be more specifically,</p>
<ul>
<li>use <code>humtum.getFollowers</code> and <code>humtum.getFollowing</code> to get the friend list</li>
<li>use <code>humtum.followOther</code> to send a follow request</li>
<li>use <code>humtum.getFollowRequests</code> to get follow requests</li>
<li>use <code>humtum.approveFollowRequest</code> and <code>humtum.rejectFollowRequest</code> to approve and reject follow request</li>
<li>use <code>humtum.createMessage</code> to broadcast a message for our followers</li>
<li>use <code>humtum.getSelf</code> to get the user profile</li>
<li>use <code>humtum.searchUsersInApp</code> to search for users</li>
</ul>
<h3 id="implementing-sentinel-chrome-extension.">Implementing Sentinel Chrome Extension.</h3>
<p>Our Chrome extension is used by the followers to get messages from expert which will be shown upon the launch of a website that is specified by the message. The code for the extension is at <a href="https://github.com/humtum-platform/HumtumChromeExtensionExample/blob/master/sentinel">this repo</a>. This code is also compatible with Firefox; however, in order to create a firefox extension, the correct redirect uri needs to be obtain from the Firefox in order to register it with the humtum-platform OIDC dynamic client registration endpoint.</p>
<p>Our Chrome extension has two components: <code>background</code> and <code>browser actions</code>. The <code>browser actions</code> helps the user login with humtum-platform. THe <code>background</code> process contains all the logic to login the user and to process all the messages received by the user.</p>
<h4 id="authentication-with-auth0">Authentication with Auth0</h4>
<p>Our Chrome extension uses a fork of <a href="https://github.com/humtum-platform/auth0-chrome">auth0-chrome</a> library to authenticate. First you need to create a env.js in the <code>src/background</code> folder.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">window</span>.<span class="at">env</span> <span class="op">=</span> <span class="op">{</span>
  <span class="dt">AUTH0_DOMAIN</span><span class="op">:</span> <span class="st">&#39;humtum.auth0.com&#39;</span><span class="op">,</span>
  <span class="dt">AUTH0_CLIENT_ID</span><span class="op">:</span> <span class="st">&#39;&lt;your-client-id&gt;&#39;</span><span class="op">,</span>
<span class="op">};</span></code></pre></div>
<p>and when the user press the login button, the <code>background</code> component receive an <code>authenticate</code> message and the below code run to authenticate with Auth0 and set up humtum to use the authentication token:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">
<span class="co">// ./src/background/main.js</span>
<span class="va">browser</span>.<span class="va">runtime</span>.<span class="va">onMessage</span>.<span class="at">addListener</span>(<span class="kw">function</span> (event) <span class="op">{</span>
  <span class="cf">if</span> (<span class="va">event</span>.<span class="at">type</span> <span class="op">===</span> <span class="st">&#39;authenticate&#39;</span>) <span class="op">{</span>

    <span class="co">// scope</span>
    <span class="co">//  - openid if you want an id_token returned</span>
    <span class="co">//  - offline_access if you want a refresh_token returned</span>
    <span class="co">// device</span>
    <span class="co">//  - required if requesting the offline_access scope.</span>
    <span class="kw">let</span> options <span class="op">=</span> <span class="op">{</span>
      <span class="dt">scope</span><span class="op">:</span> <span class="st">&quot;openid email profile offline_access read:appdata write:appdata&quot;</span><span class="op">,</span>
      <span class="dt">audience</span><span class="op">:</span> <span class="st">&quot;com.humtum.api.sentinel&quot;</span><span class="op">,</span>
    <span class="op">};</span>

    authzero <span class="op">=</span> <span class="kw">new</span> <span class="at">Auth0Chrome</span>(<span class="va">env</span>.<span class="at">AUTH0_DOMAIN</span><span class="op">,</span> <span class="va">env</span>.<span class="at">AUTH0_CLIENT_ID</span>)
    authzero
      .<span class="at">authenticate</span>(options)
      .<span class="at">then</span>(<span class="at">async</span> (authResult) <span class="op">=&gt;</span> <span class="op">{</span>
          <span class="va">humtum</span>.<span class="at">getAuth</span>().<span class="at">storeAuthResult</span>(authResult)
          <span class="va">humtum</span>.<span class="at">getAuth</span>().<span class="at">scheduleRenewal</span>(refreshthetoken)
          <span class="kw">let</span> data <span class="op">=</span> await <span class="va">humtum</span>.<span class="at">getSelf</span>()
          data <span class="op">&amp;&amp;</span> <span class="va">browser</span>.<span class="va">notifications</span>.<span class="at">create</span>(<span class="op">{</span>
            <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;basic&#39;</span><span class="op">,</span>
            <span class="dt">iconUrl</span><span class="op">:</span> <span class="st">&#39;/icons/icon128.png&#39;</span><span class="op">,</span>
            <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Login Successful&#39;</span><span class="op">,</span>
            <span class="dt">message</span><span class="op">:</span> <span class="vs">`You can use the app now`</span>
          <span class="op">}</span>)<span class="op">;</span>

          <span class="at">listenForMessage</span>()
        <span class="op">}</span>

      ).<span class="at">catch</span>(<span class="kw">function</span> (err) <span class="op">{</span>
        <span class="va">browser</span>.<span class="va">notifications</span>.<span class="at">create</span>(<span class="op">{</span>
          <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;basic&#39;</span><span class="op">,</span>
          <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Login Failed&#39;</span><span class="op">,</span>
          <span class="dt">message</span><span class="op">:</span> <span class="va">err</span>.<span class="at">message</span><span class="op">,</span>
          <span class="dt">iconUrl</span><span class="op">:</span> <span class="st">&#39;/icons/icon128.png&#39;</span>
        <span class="op">}</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>

  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="va">event</span>.<span class="at">type</span> <span class="op">==</span> <span class="st">&quot;logout&quot;</span>) <span class="op">{</span>
    <span class="va">humtum</span>.<span class="at">getCable</span>().<span class="at">disconnect</span>()
    <span class="va">filterWeb</span>.<span class="at">clear</span>()
    <span class="va">localStorage</span>.<span class="at">webFilter</span> <span class="op">=</span> <span class="va">JSON</span>.<span class="at">stringify</span>(<span class="va">filterWeb</span>.<span class="at">toJSON</span>())

  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>Users login using the login button on the launch of the extension's browser action, and then they are set up to receive messages from experts. All of the logic for the Chrome extension to interact with humtum is in <code>src/background/main.js</code></p>
<h4 id="implementing-sentinel">Implementing Sentinel</h4>
<h5 id="receving-messages-and-displaying-the-messages">Receving messages and displaying the messages</h5>
<p>We use <code>humtum.subscribeToChannel(&quot;MessagesChannel&quot;, ..., ... ,...)</code> to process the incoming messages. If the message has the correct format of:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="op">{</span>
  <span class="dt">website</span><span class="op">:</span> string<span class="op">,</span>
  <span class="dt">websitemsg</span><span class="op">:</span> string
<span class="op">}</span></code></pre></div>
<p>The website and the message will be added to a lru storage. And then, using the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated">onUpdated</a> callback, for each time user visits a website, we can check the url against the stored message. If the url passes the check, the message will be displayed to the users.</p>
<h5 id="browser-action">Browser action</h5>
<p>The <code>browser action</code> will display the profile if the user is logged in; otherwise, it will display a login button. <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage">browser.runtime.sendMessage</a> is used to communicate with the browser backend.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">
<span class="co">// ./src/browser_action/browser_action.js</span>

<span class="kw">function</span> <span class="at">logout</span>() <span class="op">{</span>
  <span class="co">// Remove the idToken from storage</span>
  <span class="va">localStorage</span>.<span class="at">clear</span>()<span class="op">;</span>
  <span class="va">browser</span>.<span class="va">runtime</span>.<span class="at">sendMessage</span>(<span class="op">{</span>
    <span class="dt">type</span><span class="op">:</span> <span class="st">&quot;logout&quot;</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="at">main</span>()<span class="op">;</span>
<span class="op">}</span>

<span class="co">// Minimal jQuery</span>
<span class="kw">const</span> $$ <span class="op">=</span> <span class="va">document</span>.<span class="va">querySelectorAll</span>.<span class="at">bind</span>(document)<span class="op">;</span>
<span class="kw">const</span> $ <span class="op">=</span> <span class="va">document</span>.<span class="va">querySelector</span>.<span class="at">bind</span>(document)<span class="op">;</span>


<span class="kw">function</span> <span class="at">renderProfileView</span>(authResult) <span class="op">{</span>
  <span class="at">$</span>(<span class="st">&#39;.default&#39;</span>).<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
  <span class="at">$</span>(<span class="st">&#39;.loading&#39;</span>).<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
  <span class="at">fetch</span>(<span class="vs">`https://</span><span class="sc">${</span><span class="va">env</span>.<span class="at">AUTH0_DOMAIN</span><span class="sc">}</span><span class="vs">/userinfo`</span><span class="op">,</span> <span class="op">{</span>
    <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&#39;Authorization&#39;</span><span class="op">:</span> <span class="vs">`Bearer </span><span class="sc">${</span><span class="va">authResult</span>.<span class="at">access_token</span><span class="sc">}</span><span class="vs">`</span>
    <span class="op">}</span>
  <span class="op">}</span>).<span class="at">then</span>(resp <span class="op">=&gt;</span> <span class="va">resp</span>.<span class="at">json</span>()).<span class="at">then</span>((profile) <span class="op">=&gt;</span> <span class="op">{</span>
    [<span class="st">&#39;picture&#39;</span><span class="op">,</span> <span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="st">&#39;nickname&#39;</span>].<span class="at">forEach</span>((key) <span class="op">=&gt;</span> <span class="op">{</span>

      <span class="kw">const</span> element <span class="op">=</span> <span class="at">$</span>(<span class="st">&#39;.&#39;</span> <span class="op">+</span> key)<span class="op">;</span>
      <span class="cf">if</span> (<span class="va">element</span>.<span class="at">nodeName</span> <span class="op">===</span> <span class="st">&#39;DIV&#39;</span>) <span class="op">{</span>
        <span class="va">element</span>.<span class="va">style</span>.<span class="at">backgroundImage</span> <span class="op">=</span> <span class="st">&#39;url(&#39;</span> <span class="op">+</span> profile[key] <span class="op">+</span> <span class="st">&#39;)&#39;</span><span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
      <span class="op">}</span>

      <span class="va">element</span>.<span class="at">textContent</span> <span class="op">=</span> profile[key]<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>
    <span class="at">$</span>(<span class="st">&#39;.loading&#39;</span>).<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
    <span class="at">$</span>(<span class="st">&#39;.profile&#39;</span>).<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
    <span class="at">$</span>(<span class="st">&#39;.logout-button&#39;</span>).<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> logout)<span class="op">;</span>
  <span class="op">}</span>).<span class="at">catch</span>(logout)<span class="op">;</span>
<span class="op">}</span>


<span class="kw">function</span> <span class="at">renderDefaultView</span>() <span class="op">{</span>
  <span class="at">$</span>(<span class="st">&#39;.default&#39;</span>).<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
  <span class="at">$</span>(<span class="st">&#39;.profile&#39;</span>).<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
  <span class="at">$</span>(<span class="st">&#39;.loading&#39;</span>).<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;.login-button&#39;</span>).<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">$</span>(<span class="st">&#39;.default&#39;</span>).<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
    <span class="at">$</span>(<span class="st">&#39;.loading&#39;</span>).<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span>
    <span class="va">browser</span>.<span class="va">runtime</span>.<span class="at">sendMessage</span>(<span class="op">{</span>
      <span class="dt">type</span><span class="op">:</span> <span class="st">&quot;authenticate&quot;</span>
    <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>

<span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span>
  <span class="kw">const</span> authResult <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">localStorage</span>.<span class="at">humtumAuth</span> <span class="op">||</span> <span class="st">&#39;{}&#39;</span>)<span class="op">;</span>
  <span class="cf">if</span> (<span class="va">authResult</span>.<span class="at">access_token</span> <span class="op">&amp;&amp;</span> <span class="va">authResult</span>.<span class="at">expires_in</span> <span class="op">*</span> <span class="dv">1000</span> <span class="op">-</span> (<span class="va">Date</span>.<span class="at">now</span>() <span class="op">-</span> <span class="va">authResult</span>.<span class="at">start</span>) <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span>
    <span class="at">renderProfileView</span>(authResult)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
    <span class="at">renderDefaultView</span>()<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>


<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;DOMContentLoaded&#39;</span><span class="op">,</span> main)<span class="op">;</span></code></pre></div>
<h5 id="misc">Misc</h5>
<p>In the case that the user has authenticate before, we automatically log the user in.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">
<span class="co">// ./src/background.main.js</span>
<span class="va">browser</span>.<span class="va">runtime</span>.<span class="va">onStartup</span>.<span class="at">addListener</span>(<span class="kw">function</span> () <span class="op">{</span>
  <span class="cf">if</span> (<span class="va">humtum</span>.<span class="at">getAuth</span>().<span class="at">isAuthenticated</span>() <span class="op">&amp;&amp;</span> <span class="va">humtum</span>.<span class="at">getAuth</span>().<span class="at">isValid</span>()) <span class="op">{</span>
    <span class="at">refreshthetoken</span>()
    <span class="at">listenForMessage</span>()
  <span class="op">}</span>

  <span class="cf">if</span> (<span class="va">localStorage</span>.<span class="at">webFilter</span>) <span class="op">{</span>
    <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">localStorage</span>.<span class="at">webFilter</span>).<span class="at">forEach</span>(v <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="va">filterWeb</span>.<span class="at">set</span>(<span class="va">v</span>.<span class="at">key</span><span class="op">,</span> <span class="va">v</span>.<span class="at">value</span>)
    <span class="op">}</span>)
  <span class="op">}</span>
<span class="op">}</span>)

<span class="va">browser</span>.<span class="va">runtime</span>.<span class="va">onInstalled</span>.<span class="at">addListener</span>(<span class="kw">function</span> () <span class="op">{</span>
  <span class="cf">if</span> (<span class="va">humtum</span>.<span class="at">getAuth</span>().<span class="at">isAuthenticated</span>() <span class="op">&amp;&amp;</span> <span class="va">humtum</span>.<span class="at">getAuth</span>().<span class="at">isValid</span>()) <span class="op">{</span>
    <span class="at">refreshthetoken</span>()
    <span class="at">listenForMessage</span>()
  <span class="op">}</span>

  <span class="cf">if</span> (<span class="va">localStorage</span>.<span class="at">webFilter</span>) <span class="op">{</span>
    <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">localStorage</span>.<span class="at">webFilter</span>).<span class="at">forEach</span>(v <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="va">filterWeb</span>.<span class="at">set</span>(<span class="va">v</span>.<span class="at">key</span><span class="op">,</span> <span class="va">v</span>.<span class="at">value</span>)
    <span class="op">}</span>)
  <span class="op">}</span>
<span class="op">}</span>)</code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>In this tutorial, we create Sentinel using humtum-platform as a backend, a Electron app for users to manage their followers and following, and a Chrome Extension to display messages from user's following.</p>
</body>
</html>
